{"version":3,"sources":["herb/runtime.cljs"],"mappings":"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","names":["herb.runtime/dev?","js/goog.DEBUG","js/herb","js/herb.runtime","js/herb.runtime.injected-styles","herb.runtime/injected-styles","cljs.core.atom.cljs$core$IFn$_invoke$arity$1","js/herb.runtime.injected-keyframes","herb.runtime/injected-keyframes","js/herb.runtime.injected-global","herb.runtime/injected-global","js/herb.runtime.options","herb.runtime/options","p__41583","map__41584","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply.cljs$core$IFn$_invoke$arity$2","cljs.core/hash-map","cljs.core.get.cljs$core$IFn$_invoke$arity$2","herb.runtime/update-state","state","ident","data","data-string","element","css","temp__5733__auto__","old","cljs.core/deref","cljs.core/assoc-in","cljs.core/first","cljs.core/last","herb.runtime/combinator-fns","garden.selectors/>","garden.selectors/+","garden.selectors/-","garden.selectors/descendant","herb.runtime/render-style!","identifier","new","style","vec__41586","cljs.core.nth.cljs$core$IFn$_invoke$arity$3","map__41589","classname","pseudo","media","supports","prefix","vendors","combinators","cljs.core/with-meta","cljs.core.map.cljs$core$IFn$_invoke$arity$2","p__41591","vec__41592","vec__41595","seq__41596","cljs.core/seq","first__41597","cljs.core/next","combinator","elements","cfn","cljs.core.apply.cljs$core$IFn$_invoke$arity$3","cljs.core.ex_info.cljs$core$IFn$_invoke$arity$2","css-str","garden.core.css.cljs$core$IFn$_invoke$arity$variadic","G__41598","G__41599","goog.dom/append","cljs.core.swap_BANG_.cljs$core$IFn$_invoke$arity$variadic","herb.runtime/create-element!","attr","head","js/document","js/Error","herb.runtime/create-style!","data-str","G__41600","cljs.core.assoc.cljs$core$IFn$_invoke$arity$3","herb.runtime/inject-style!","injected","target","cljs.core/not","var_args","args__4736__auto__","len__4730__auto__","i__4731__auto__","argseq__4737__auto__","cljs.core/IndexedSeq","herb.runtime/inject-obj!","seq41601","G__41602","G__41603","self__4717__auto__","sym","dispatch","obj","G__41604","cljs.core/Keyword","cljs.core._EQ_.cljs$core$IFn$_invoke$arity$2","or__4131__auto__","cljs.core/name","inner-html","goog.object/get","G__41605","G__41606","G__41607","goog.object/set","cljs.core.swap_BANG_.cljs$core$IFn$_invoke$arity$4","cljs.core/assoc"],"sourcesContent":["(ns herb.runtime\n  (:require [goog.dom :as dom]\n            [goog.object :as gobj]\n            [garden.core :refer [css]]\n            [garden.selectors :as s]))\n\n(def dev? ^boolean js/goog.DEBUG)\n\n(defonce\n  ^{:private true\n    :doc \"Atom containing all styles added to DOM. Takes the form of a map with\n  classnames as keys. The map entry contains a `:data` which is Herb's\n  representation of a style unit, `:data-string` which is what is used as the\n  style data attribute in DOM, and `:css` which contains the rendered CSS\n  string.\"}\n  injected-styles (atom {}))\n\n(defonce\n  ^{:private true\n    :doc \"Atom containing all keyframe CSS added to DOM. Takes the form of a map\n  with a namespace as a key. A map entry contains the keys `:data` which is herb's\n  representation of a keyframe unit and `:css` which is the rendered CSS\n  string\"}\n  injected-keyframes (atom {}))\n\n(defonce\n  ^{:private true\n    :doc \"Atom containing all global style added to DOM. Takes the form of a map\n  with namespace as keys. A map entry contains `:data` which is a collection of\n  global styles for a given via defglobal call and `:css` that contains the\n  rendered CSS\"}\n  injected-global (atom {}))\n\n(defonce\n  ^{:doc \"Atom containing a map with options passed from `herb.core/init!`.\n  Entry includes `:vendors` and `:auto-prefix`\"}\n  options (atom {}))\n\n(defn- update-state\n  \"Either update a style in state, or create it depending on existing state.\"\n  [state ident {:keys [data data-string element]} css]\n  (let [css (if-let [old (get @injected-styles ident)]\n              (str (:css old) \"\\n\" css)\n              css)]\n    (-> (assoc-in state [ident :data (first data)] (last data))\n        (assoc-in [ident :data-string] data-string)\n        (assoc-in [ident :element] element)\n        (assoc-in [ident :css] css))))\n\n(def combinator-fns\n  {:> s/>\n   :+ s/+\n   :- s/-\n   :descendant s/descendant})\n\n(defn- render-style!\n  \"Renders CSS, and appends to DOM. Ensure state is in sync with DOM.\"\n  [identifier new]\n  (let [style (let [[classname {:keys [style pseudo media supports prefix vendors combinators]}] (:data new)]\n                [[classname (with-meta style {:prefix prefix :vendors vendors})\n                  pseudo media supports]\n                 [(map (fn [[[combinator & elements] style]]\n                         (if-let [cfn (get combinator-fns combinator)]\n                           [(apply cfn classname elements) style]\n                           (throw (ex-info \"Unsupported combinator function \"\n                                           {:combinator combinator\n                                            :elements elements\n                                            :style style}))))\n                       combinators)]])\n        css-str (css {:vendors (seq (:vendors @options))\n                      :pretty-print? dev?\n                      :auto-prefix (seq (:auto-prefix @options))}\n                     style)]\n    (dom/append (:element new) (str \"\\n\" css-str))\n    (swap! injected-styles update-state identifier new css-str)))\n\n\n(defn- create-element!\n  \"Create an element in the DOM with an optional data-herb attribute\"\n  [attr]\n  (let [head (.-head js/document)]\n    (assert (some? head) \"An head element is required in the dom to inject the style.\")\n    (let [element (.createElement js/document \"style\")]\n      (.setAttribute element \"type\" \"text/css\")\n      (when attr\n        (.setAttribute element \"data-herb\" attr))\n      (.appendChild head element)\n      element)))\n\n(defn- create-style!\n  \"Create a style element in head if identifier is not already present Attach a\n  data attr with namespace and call render-style with new element\"\n  [identifier new data-str]\n  (let [element (create-element! data-str)]\n    (render-style! identifier (cond-> {:data new :element element}\n                                data-str (assoc :data-string data-str)))))\n\n\n(defn inject-style!\n  \"Main interface to runtime. Takes an identifier, new garden style data\n  structure, fully qualified name. Make sure to add style only where\n  necessary. Returns the injected style state object.\"\n  [identifier new data-str]\n  (let [injected (get @injected-styles identifier)\n        target (get (:data injected) (first new))]\n    (cond\n      (not injected)\n      (create-style! identifier new data-str)\n\n      (and (some? injected)\n           (not target))\n      (render-style!\n       identifier\n       {:data new\n        :element (:element injected)\n        :data-string data-str}))\n\n    (get @injected-styles identifier)))\n\n(defn inject-obj!\n  \"Inject collection of style objects in a common element, used by passing a\n  dispatch in the form of :keyframes or :global\"\n  [sym dispatch & obj]\n  (let [state (case dispatch\n                :global injected-global\n                :keyframes injected-keyframes)]\n    (when-not (= (:data (get @state sym)) obj)\n      (let [css-str (css {:pretty-print? dev?} obj)]\n        (let [element (or (.querySelector js/document (str \"style[data-herb=\\\"\" (name dispatch) \"\\\"]\"))\n                          (create-element! (name dispatch)))\n              inner-html (gobj/get element \"innerHTML\")]\n          (gobj/set element \"innerHTML\" (str inner-html (when dev? \"\\n\") css-str)))\n        (swap! state assoc sym {:data obj :css css-str})))))\n"]}